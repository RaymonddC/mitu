// Prisma Schema for MNEE Autonomous Payroll Agent
// Database: PostgreSQL

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Employer account
model Employer {
  id              String    @id @default(uuid())
  walletAddress   String    @unique
  companyName     String
  email           String?
  payrollDay      Int       @default(28) // Day of month (1-28)
  monthlyBudget   Decimal?  @db.Decimal(20, 8) // Optional spending cap
  active          Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  employees       Employee[]
  payrollLogs     PayrollLog[]
  alerts          Alert[]

  @@map("employers")
}

// Employee records
model Employee {
  id              String    @id @default(uuid())
  employerId      String
  name            String
  email           String?
  walletAddress   String
  salaryAmount    Decimal   @db.Decimal(20, 8)
  paymentCycle    String    @default("monthly") // "monthly" | "weekly" | "custom"
  customPayDay    Int?      // Override employer default (1-28)
  active          Boolean   @default(true)
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  employer        Employer  @relation(fields: [employerId], references: [id], onDelete: Cascade)
  payrollLogs     PayrollLog[]

  @@index([employerId])
  @@index([walletAddress])
  @@map("employees")
}

// Payroll execution logs
model PayrollLog {
  id              String    @id @default(uuid())
  employerId      String
  employeeId      String
  amount          Decimal   @db.Decimal(20, 8)
  txHash          String?   // MNEE transaction hash
  status          String    // "pending" | "completed" | "failed" | "retrying"
  failureReason   String?
  idempotencyKey  String    @unique // Prevent duplicate payments
  executedAt      DateTime  @default(now())
  confirmedAt     DateTime?
  retryCount      Int       @default(0)
  metadata        Json?     // Additional context (agent version, gas used, etc.)

  employer        Employer  @relation(fields: [employerId], references: [id], onDelete: Cascade)
  employee        Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employerId])
  @@index([employeeId])
  @@index([status])
  @@index([executedAt])
  @@index([idempotencyKey])
  @@map("payroll_logs")
}

// AI Agent alerts and recommendations
model Alert {
  id              String    @id @default(uuid())
  employerId      String
  severity        String    // "info" | "warning" | "critical"
  category        String    // "insufficient_funds" | "invalid_wallet" | "suspicious_change" | "optimization"
  title           String
  message         String
  resolved        Boolean   @default(false)
  metadata        Json?
  createdAt       DateTime  @default(now())
  resolvedAt      DateTime?

  employer        Employer  @relation(fields: [employerId], references: [id], onDelete: Cascade)

  @@index([employerId])
  @@index([severity])
  @@index([resolved])
  @@map("alerts")
}

// System configuration (singleton)
model SystemConfig {
  id              String    @id @default("system")
  agentEnabled    Boolean   @default(true)
  lastAgentRun    DateTime?
  minSalaryAmount Decimal   @default(0) @db.Decimal(20, 8)
  maxSalaryAmount Decimal   @default(1000000) @db.Decimal(20, 8)
  settings        Json?
  updatedAt       DateTime  @updatedAt

  @@map("system_config")
}
